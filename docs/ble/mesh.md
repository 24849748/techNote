
> [谷雨文档中心/BLE-Mesh技术揭秘](http://doc.iotxx.com/BLE-Mesh%E6%8A%80%E6%9C%AF%E6%8F%AD%E7%A7%98)

## 基础概念

### node

mesh 网络中的设备

### Provisioner

负责将为配网的设备加入 mesh 网络，分配 NetKey 和地址

### NetKey

网络层密钥，用于节点间的通信加密

### AppKey

应用层密钥，用于特定应用加解密

### Model

消息、状态、设备行为等已被定义在规格中，称为 模型
定义设备的功能和行为

- 开关模型（on/off model）
- 调光模型（dimmer model）

## 配网流程

配网是将设备加入 Mesh 网络的过程，主要步骤如下：
1. 初始化
   设置设备的 UUID 和配网承载层（PB-ADV 或 PB-GATT）。
2. 设备发现
   Provisioner 扫描未配网设备的广播包，获取设备信息 4。
3. 密钥交换
   通过 ECDH 协议生成共享密钥，用于加密通信。
4. 分配网络参数
   Provisioner 分配 NetKey、AppKey 和单播地址给设备。
5. 配置模型
   绑定 AppKey 到设备的模型，使其能够接收和发送消息。


## 以消息为中心的通信

使用发布订阅消息系统


## 中继

mesh 网络能将网络中某些设备指定为 “中继设备”，中继设备能够转发从其他设备接收到的消息。

每次中继称为 “跳”，最多有 127 跳。


## 管理型网络泛洪

flooding，"广播" 到所有相邻节点。直到到达目标节点

蓝牙mesh网络采用一种称为 “网络泛洪（flooding）” 的方式来发布和中继消息。

### 网络泛洪优势

网络泛洪的优势在于无需特定设备专门扮演集中式路由器的角色（有点去中心化的意思）

如果中心挂了，可能整个网络都没办法运行

网络泛洪的方式也意味着消息一般能够通过多重路径到达其目的地。这就构建了一个相当可靠的网络。

### 优化 mesh 网络

所有数据包都包含一个称为TTL的字段，它可用于限制消息中继的跳数。

TTL 的值从 0 到 127，默认值是 127。每次消息中继，TTL 的值减 1。当 TTL 值为 0 时，消息将被丢弃，不再中继。

每台设备都包含消息缓存，以确定自身是否已经中继过该消息。如果是，则会立即丢弃该消息，从而避免上层堆栈进行不必要的处理。

功率非常受限的设备（例如由小型电池持续供电多年的传感器）可能被指定为 “低功耗节点” 

低功耗节点能够与一个或多个被指定为 “friends” 的设备协同工作。

低功耗节点将消息转发给其 friends，而 friends 则将消息转发给其他设备。

**低功耗节点和 “friends” 之间的关系理所当然就称为 “friendship”。**

对设备来说，通过与 “friends” 的合作, 低功耗节点能够以合理的频率接收消息，
但重要的是，相较于始终 “聆听” 所有消息，它能够以更低的频率工作，同时确保发送来的罕见事件也不会被遗漏。

“Friends” 节点帮 低功耗节点 完成大量工作。
它们能够为所服务的低功耗节点存储消息，并在 低功耗节点 明确要求的情况下向其提供消息
低功耗节点 可按照自身的规划进行操作，从而最有效地利用无线电。

## proxy 节点

mesh 网络会指定一台设备来扮演代理节点（proxy node）的角色

## 安全性

# 其他了解

1. SIG mesh 对安全性要求很高，跳数多的场景对芯片要求也高
2. 国内大部分私有 mesh 只做广播
3. 功耗跟应用场景强相关，一般很难做评估
4. 泰凌微的 mesh 一般也只做到 3-4 跳

