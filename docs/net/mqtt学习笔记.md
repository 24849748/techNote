
## 特性

* **轻量级**：开销低、报文小
* **可靠**：QoS0、1、2，会话感知和持久连接
* **安全通信**：MQTT 提供传输层安全（TLS）和安全套接层（SSL）加密功能
* **双向通信**：客户端既可发布、又可订阅
* **连续、有状态的会话**：
  客户端与 Broker 之间保持有状态会话，即使在断开连接后也能记住订阅和未传递的消息。
  客户端还可以在建立连接时指定一个保活间隔，这会促使 Broker 定期检查连接状态。如果连接中断，Broker 会储存未传递的消息（根据 QoS 级别确定），并在客户端重新连接时尝试传递它们。
  这个特性保证了通信的可靠性，降低了因间断性连接而导致数据丢失的风险。
* **松耦合性**：发布订阅模式

## 发布/订阅模式

Publish-Subscribe Pattern

它将发送消息的客户端（发布者）与接收消息的客户端（订阅者）解耦，使得两者不需要建立直接的联系也不需要知道对方的存在。

下图展示了 MQTT 发布/订阅过程：

温度传感器作为**发布者客户端**连接到 MQTT Broker，并通过**发布**操作将温度数据发布到一个特定**主题**（例如 Temperature）。MQTT **Broker** 接收到该消息后会负责将其**转发**给订阅了相应主题（Temperature）的**订阅者客户端**。

![20250514225838](https://cdn.jsdelivr.net/gh/24849748/PicBed/ob/20250514225838.png)

## 角色概念

### 发布者（Publisher）

负责将消息发布到主题上，发布者一次只能向一个主题发送数据
发布者发布消息时也无需关心订阅者是否在线。

### 订阅者（Subscriber）

订阅者通过订阅主题接收消息，且可一次订阅多个主题。
MQTT 还支持通过共享订阅的方式在多个订阅者之间实现订阅的负载均衡。

### 代理（Broker）

负责接收发布者的消息，并将消息转发至符合条件的订阅者。
另外，代理也需要负责处理客户端发起的连接、断开连接、订阅、取消订阅等请求。

### 主题（Topic）

主题是 MQTT 进行消息路由的基础，它类似 URL 路径，使用斜杠 / 进行分层，比如 sensor/1/temperature。
一个主题可以有多个订阅者，代理会将该主题下的消息转发给所有订阅者；一个主题也可以有多个发布者，代理将按照消息到达的顺序转发。

![20250514223429](https://cdn.jsdelivr.net/gh/24849748/PicBed/ob/20250514223429.png)


```
chat/room/1

sensor/10/temperature

sensor/+/temperature
```

MQTT 主题支持以下两种通配符：+ 和 #。

* +：表示单层通配符，例如 a/+ 匹配 a/x 或 a/y。
* #：表示多层通配符，例如 a/# 匹配 a/x、a/b/c/d。

!!! Note
    通配符主题只能用于订阅，不能用于发布。

## 消息路由

MQTT 发布/订阅模式中，一个客户端既可以是发布者，也可以是订阅者，也可以同时具备这两个身份

当客户端发布一条消息时，它会被发送到代理，然后代理将消息路由到该主题的所有订阅者。

当客户端订阅一个主题时，它会收到代理转发到该主题的所有消息。

## 服务质量等级(QoS)

MQTT 提供了三种服务质量（QoS），在不同网络环境下保证消息的可靠性。

* QoS 0：消息最多传送一次。如果当前客户端不可用，它将丢失这条消息。
* QoS 1：消息至少传送一次。
* QoS 2：消息只传送一次。


## 遗嘱消息

遗嘱消息是 MQTT 协议中的一个重要功能，它解决了只有服务端才能知道客户端是否在线的问题，使我们能够为意外离线的客户端优雅地完成善后事宜。

客户端可以在连接时在服务端中注册一个遗嘱消息，与普通消息类似，我们可以设置遗嘱消息的主题、有效载荷等等。
当该客户端意外断开连接，服务端就会向其他订阅了相应主题的客户端发送此遗嘱消息。

> 假如传感器设备不是定期发布最新数值，而是有变化时发布，那么订阅者可以及时获得最新数据，但也无法根据是否及时收到消息来判断传感器是否离线。
> 借助遗嘱消息，我们可以立即得知传感器保持活动超时，而且不必总是获取传感器发布的值。


### 命名问题

Will Message = Last Will and Testament（LWT）

Last Will and Testament（LWT）是 3.1 规范摘要中提到的一个概念，MQTT 规范中明确使用 Will Message 这个名字。


### 遗嘱消息如何使用

1. 客户端在连接时，通过设置 CONNECT 报文的 Will Flag 和 Will QoS、Will Retain、Will Topic 和 Will Message 字段，向服务端注册一条遗嘱消息。
2. 
![20250515083334](https://cdn.jsdelivr.net/gh/24849748/PicBed/ob/20250515083334.png)




### 遗嘱消息使用技巧

#### 与保留消息一起使用

服务端一旦发布了遗嘱消息，就会将它从会话中删除。如果关心此遗嘱消息的客户端不在线，那么它就错过了这条遗嘱消息。

为了避免这种情况，我们可以将遗嘱消息设置为保留消息，这样遗嘱消息在被发布后，还会以保留消息的形式存储在服务端中，客户端可以在任何时候获取这条遗嘱消息。

如果更进一步，我们还可以实现对指定客户端的状态监控。

让客户端 myclient 在每次连接时都指定一个主题为 myclient/status，有效载荷为 offline 并且设置了 Will Retain 标志的遗嘱消息。每当连接成功，就向主题 myclient/status 发布一个有效载荷为 online 的保留消息。这样，我们就可以随时订阅主题 myclient/status，来获取客户端 myclient 的最新状态。


#### 会话过期通知

通过设置一个大于 Session Expiry Interval 的 Will Delay Interval，服务端可以以遗嘱消息的形式发出会话过期通知。这对于一些更关心会话过期而不是网络连接中断的应用更加有用。即便是主动下线，客户端可以发送一个 Reason Code 为 0x04 的 DISCONNECT 报文要求服务端仍然发送遗嘱消息。