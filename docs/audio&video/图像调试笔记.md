---
title: 图像调试笔记
date: 2024-11-19 11:19:00
# description: 
# mermaid: true
categories:
  - video
tags:
  - video, pq, iq
---

## 基础概念

### ISP 名词

|算法|功能|描述|
|--|--|--|
|BLC|黑电平校正|Sensor 相关的黑电平校正|
|DPC|坏点矫正|提供对静态坏点和动态坏点的检测和校正功能|
|BNR|Bayer降噪|提供在Bayer domain中实现对图像的去噪，目的是去除噪声的同时，保留细节。|
|FPN|固定噪声消除|通过标定的黑帧或黑行对Sensor输入的图像进行校正，达到去除Sensor FPN的目的|
|DEMOSAIC|解马赛克|将Bayer格式的Raw图像转换到RGB图像|
|CAC|紫边校正|用来校正由镜头引入的轴向色差（紫边）与横向色差（物体相对两侧带有不同颜色的彩色边缘）。|
|GAMMA|图像亮度调整|该模块根据伽马曲线分（R，G，B）三个颜色通道调整亮度。|
|AWB|自动白平衡|该模块输出全局统计信息和区域统计信息，软件基于统计信息完成自动白平衡功能。|
|AE|自动曝光|该模块输出自动曝光信息的统计，软件根据统计信息调节Sensor可实现自动曝光的功能。|
|AF|自动对焦|当前不支持AF算法，仅支持AF统计信息，统计图像清晰度评价信息，用于完成支持自动对焦功能。|
|LSC|镜头阴影校正|用于镜头阴影校正。当前只支持mesh shading。|
|SHARPEN|图像锐化|实现图像的锐化，提高图像的清晰度。
|DEHAZE|自动去雾处理|提供强大的分区域去雾能力以改善雾霾场景下视频的对比度和清晰度。|
|CLUT|颜色三维查找表增强|利用17*17*17大小的3D LUT实现复杂的颜色调整操作，比如亮度的调整，饱和度的调整，阴影区域，中间亮度区域，高亮区域分别调整。|
|LDCI|局部对比度增强|基于局域直方图均衡的方法来增强局部的对比度，提升暗区细节，同时对图像中高频进行一定的增强，提升对比度。|
|CA|色彩自适应|饱和度调整及热成像上色，当前不支持热成像上色。|
|3DNR|3D降噪|通过参数配置，把图像中的高斯噪声去除，使得图像变得平滑，同时降低了编码码率。|
|HLC|高光屏蔽|将图像中亮度最高的区域拉灰，以减少类似于车灯等高亮光源对人眼的刺激。|
|Crop|图像裁剪|实现对输入图像裁剪的功能。|
|GE|图像质量提升|校正Gr与Gb两个通道的失衡，提高部分场景的图像质量。|
|Expander|解压缩数据|将Sensor内部压缩的数据，进行解压缩。|
|DG|数字增益|提供分通道的数字增益功能。|
|MG|最大增益统计|MG模块统计DRC后分块均值，与AE统计分块均值相比，可以得出分块均值增益最大值。MG统计信息包含8bit精度分块R/Gr/Gb/B均值统计，分块最大支持17*15|
|CCM|颜色校正|通过标准3*3的矩阵和矢量偏移量可完成颜色空间的线性校正。|
|CSC|色域转换|通过标准3*3的矩阵和矢量偏移量将输入{R，G，B}转换为{Y，U，V}。|
|DIS|防抖|通过比较两帧之间的差异，计算出帧间的偏移量，根据偏移量进行裁剪，消除图像抖动。|
|LDC|镜头畸变矫正|对一帧图像进行镜头畸变矫正和展宽功能。展宽功能当前不支持。|


### 白平衡
### 色温
### 色域

### 饱和度
Saturation，指色彩的鲜艳程度

在YCbCr空间来看，Cb和Cr等于128时，饱和度为0
|Cr-128|和|Cr-128|越大，饱和度也越大

饱和度的计算公式
f(x,s)=(x-128)*s + 128, x=Cb or Cr，s>=0

表达式中s表示饱和度调整幅度，s=1表示不调整，s=0表示灰度图，0<s<1表示降低饱和度，s>1表示增加饱和度。

Saturation从左到右分别为s=0, 0.5, 1, 2

### 对比度
Contrast


### Gamma

影响亮度和对比度

Gamma > 1 : 暗部亮度被压暗，亮部对比度增强，适合突出高光细节，但暗部可能会丢失细节。
Gamma < 1 : 暗部亮度被提亮，图像整体显得更柔和，适合保留暗部细节，但亮部可能失去对比。
Gamma = 1 : 表示线性响应，亮度分布与输入信号一致。

### CCM

![20241119141629](https://cdn.jsdelivr.net/gh/24849748/PicBed/ob/20241119141629.png)



## 主要步骤

1. 黑电平校正（BLC跟据不同ISO增益下进行测量黑电平）
   黑电平主要是因为sensor本身存在暗电流，导致值大小有一定的偏移
2. 白平衡（AWB）
   白平衡主要是解决图像中白块灰块产生色偏的问题
3. 色彩转换矩阵（CCM）
   CCM颜色转换矩阵主要是解决红绿蓝等色块颜色准确性和饱和度问题
4. Gamma校正
   Gamma校正主要是用于提高图像全局对比度和亮度
5. YUVsharpen调节
   YUVsharpen用于调节图像锐度细节信息（部分参数也可以提高图像亮度）
6. DCR调节
   DCR用于提高图像暗区细节
7. LDC局部对比度
   LDCI用于提高图像局部对比度和亮度
8. Dehaze强度调节
   Dehaze用于解决图像清晰度和对比度
9. 3DNR夜晚图像去噪
   3DNR用于调试解决图像夜晚清晰度和和噪声问题


还包括了去马赛克、阴影校正、坏点校正等


## 涉及模块

1. 亮度：
   * 自动曝光（AE）
   * DRC
   * Shading 校正
2. 清晰度和噪声：
   * Demosaic
   * 3DNR
   * NR
   * DPC
3. 通透性
   * Gamma
   * LDCI
   * Dehaze
   * DRC
4. 色彩
  * AWB
  * CCM
  * CLUT
  * CA

