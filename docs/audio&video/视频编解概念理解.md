---
title: 【音视频】视频编解概念理解
date: 2024-11-20 10:43:43
# description: 
# mermaid: true
categories:
  - video
tags:
  - video, iso
---

> 这部分概念在梳理过程中，发现有相互关联的情况

## 压缩/编码

视频的播放就是一张张图片连续的播放

实际上不能一张张保存/传输，否则会占用大量的存储空间和带宽

压缩分：
* 帧内压缩，压缩自己本身，不参考其他帧
* 帧间压缩，参考其他帧，对差异部分进行压缩

帧间压缩有三个原则：
1. I 帧作为关键帧，可以自我解码
2. P 帧依赖于其前面的非 B 帧（I 帧或 P 帧）
3. B 帧依赖于其前后两个非 B 帧（I 帧或者 P 帧）

下面的概念基本是属于帧间压缩的

## GOP

Group of Pictures，一组连续的帧，包含I帧、P帧和B帧

GOP 是 I 帧的间隔，从当前 I 帧开始，到下一个 I 帧结束

```
| I P P P  ... P P | I
| ↑              ↑ |
GOP start     GOP end
```

## I 帧

Intra Picture，也叫关键帧

它可以被单独解码成一张完整的图片

最惯性思维的理解是，一个视频全是 I 帧，每个 I 帧就是一个 GOP。一般情况不会这么做

## IDR 帧

Instantaneous Decoding Refresh，及时解码刷新

IDR 帧必须是一个 I 帧，但是 I 帧不一定是 IDR 帧

这个帧出现的时候，是告诉解码器，可以清除掉所有的参考帧，这是一个全新的序列，新的GOP已经开始。

## P 帧

Predictive Picture，预测帧

会参考之前的I帧或者P帧，采用 **运动预测** 的方式进行帧间编码。

## B 帧

Bidirectionally predicted picture，双向预测帧

依赖前后两个参考帧，与 P 帧区别多了一个参考帧

## 帧率

一秒钟多少个数据帧，单位是 fps（frames per second）

## 码流

也叫码率，单位时间内视频数据量的大小，单位是 bps（bits per second）

码率 = 视频数据大小 / 时间


## IFG 帧间距

Interframe Gap，以太网相邻两帧之间的时间断

以太网发送方式是一个帧一个帧发送的，帧与帧之间需要间隙，即帧间距 IFG 也可称其为 IPG (Interpacket Gap)

IFG 指的是一段时间，不是距离，单位通常用微秒（μs）或纳秒（ns）

![20241120114736](https://cdn.jsdelivr.net/gh/24849748/PicBed/ob/20241120114736.png)

IFG 最小值是 96 bit time，即发送 96 位数据需要的时间，最大值是 512 bit time

以太网分 10M/100M/1000M，但不管哪种，两帧之间最少要有 96 bit time，即：
* 10M   9600 ns
* 100M  960 ns
* 1000M 96 ns


![以太网传输示例](https://cdn.jsdelivr.net/gh/24849748/PicBed/ob/20241120115338.png)

IFG 增大，设备的有效速度减小，可以解决因速度过快丢包的问题；
IFG 减小（但必须大于 96 bit time），设备的有效速度增大，可以解决因速度过慢导致测试超时的问题。

## 结论 / 总结

TODO 整理

### GOP 是两个 I帧 的间隔

从这里说，一个GOP就是1-10号帧，但是10号帧还参考了11号帧，那就违反了GOP是一组完整的图片的定义。所以严格意义上讲GOP必须是以IDR帧开始，到下一个IDR帧结束，一个GOP的所有视频帧的参考帧必须在GOP之中。
视频帧头信息里面还会有pts和dts，pts代表显示时间，dts代表解码时间，这里的时间类似顺序，越大，顺序越靠后。


### 在码率相同的情况下，GOP 越大，意味着 P/B 帧越多，也就更容易获取较好的图像质量

首先，P/B帧的数量多少，只影响画面流畅度，不影响图像还原度和清晰度。

其次，码率固定情况下，P/B越多，那就意味着单位时间内，P/B的大小更小（码率=单位时间内所有帧数据的大小之和），

P和B越小，意味着压缩率更高，虽然视频会更加流畅，但是图像质量也就是图像还原度会更低。

在这种情况下，说容易获得较好的图像质量好像有点牵强，毕竟人眼通常情况下超过24帧的帧率之后，就不会感觉到画面卡顿。

帧率固定的情况下（这种情况下，我们可以视为码流和GOP大小成正比例关系），GOP大小会影响画面质量。

比如看直播时候，如果画面波动比较大，码流就会大起来，这个时候就能分析出来，P帧会变大，画面幅度大，导致压缩率变低。

如果这个时候强制限制码流的话，画面可能会失真，可能出现马赛克现象。（AR：所以避免马赛克的话就是不能限制码流？）


### 如果画面静止不动，那么P帧会很小，压缩率很高，码流也就是GOP大小自然会变小。（AR：GOP大小∝码率？（正比于））

GOP拉大，码率不变，帧率不变，那就是每个帧的数据量变大，压缩率变低，画面还原度变高

0928更新GOP拉大和GOP拉长的问题（实际情况需要自己判断）
拉长是指本来1s产生一个GOP，也就是一秒一个IDR帧，但是改成2s一个GOP，帧率不变。

拉大是指GOP容量变大，本来1sGOP大小100KB，变成120KB，帧数不变。

如果GOP中帧数增加，在压缩率稳定的情况下（正常情况下压缩率会变化，看图像变化比例）必然会造成GOP变大，如果GOP大小保证不变，可以采取减少I帧（注意不是IDR帧）来换取更多的P和B帧。


## 我们的场景是图像中小范围波动，我们要保证这个小范围的清晰度，需要增加更多的P帧？

在计算码流变化之中，需要明确GOP是怎么变化的。

在帧率固定的前提下，比如说2s一个I帧（上面说了直播一般I帧和IDR帧等同，没有B帧），影响码流大小的是画面变化幅度，如果画面静止不动的话，码流保持在很稳定的状态；如果画面变化幅度比较大，那码流就会变大。
