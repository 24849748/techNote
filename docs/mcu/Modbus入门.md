# Modbus

权威文档（todo）
> **modbus_application_protocol_specification_v1.1b3.pdf**
> **基于Modbus协议的工业自动化网络规范 GB-T19582.1-2008.pdf**

## 介绍

modbus是一种总线协议，和 `I2C` 和 `SPI` 类似，有主有从
* modbus支持单主多从，最多247个从机设备
* modbus协议是一种**请求/应答**的过程，需要主机发起通讯请求，从机响应的过程

### 名词

PDU：协议数据单元，包括功能码和数据
ADU：应用数据单元

## 4种数据类型

modbus规定，进行读写操作的数据类型按读写的属性和类型分为：
| 数据类型       | 作用       | 说明                      |
| ---------- | ---------- | ------------------------- |
| 离散量输入 | 1bit 只读  | 数据由I/O系统提供 |
| 线圈       | 1bit 读写  | 可通过程序改写  |
| 输入寄存器 | 16bit 只读 | 数据由I/O系统提供 |
| 保持寄存器 | 16bit 读写 | 可通过程序改写  |


## 3种传输模式

* 基于串口的**Modbus-RTU**
    * 使用最广泛
    * CRC-16_Modbus校验算法
* 基于串口的**Modbus-ASCII**
    * 一个字符的原始数据需要两个字符来表示
    * LRC校验算法
* 基于网口的**Modbus-TCP**
    * 占用502端口

## 3类功能码

* 公共功能码
* 用户功能码
* 保留功能码

Modbus功能码分类
![image.png|183](https://raw.githubusercontent.com/24849748/PicBed/main/ob/202306111009885.png)

实际常用的4个功能码：03、04、06、10
* 0x03：读多个保持寄存器
* 0x04：读输入寄存器
* 0x06：写单个保持寄存器
* 0x10：写多个保持寄存器



## 数据帧

无论三种传输方式，Modbus数据帧格式都一样
![image.png](https://raw.githubusercontent.com/24849748/PicBed/main/ob/202306110959658.png “通用数据帧”)
<center><div style="color:orange; border-bottom: 1px solid #d9d9d9; display: inline-block; color: #999; padding: 2px;">通用数据帧格式</div> </center>
* 地址域：1字节，从机地址，1~247为有效地址，0为广播地址
* 功能码：1字节，表示主机请求数据的类型
* 数据：N字节，包括寄存器地址和寄存器数据
* 差错校验：CRC或LRC


### Modbus-RTU数据帧

![image.png|539](https://raw.githubusercontent.com/24849748/PicBed/main/ob/202306142050464.png)
* 子节点：1byte，0~247
* 功能码：1byte
* 数据块：0~252bytes
* CRC校验值：2bytes，低8位在前

Modbus RTU帧间隔时间要求大于3.5个字节 
且帧内字节间隔时间小于1.5个字节，否则认为接收不完整

RTC采用CRC校验算法，对帧内全部数据进行计算

#### 示例：

```c
// 写单个寄存器0x06
// 主机发送：
01 06 01 05 01 90 99 CB
// 从机回复：
01 06 01 05 01 90 99 CB

// 0x01: 从机地址
// 0x06: 写单个寄存器
// 01 05: 寄存器地址 
// 01 90: 写入的数值
// 99 CB: CRC校验值
```

```c
// 读单个寄存器0x03
主机发送：01 03 01 05 00 01 95 f7  
从机回复：01 03 02 56 78 87 c6
```

```c
// 写多个寄存器
// 主机发送：
01 10 01 05 00 03 06 11 02 03 04 05 66 4a 12
// 从机回复：
01 10 01 05 00 03 91 f5

// 0x01: 从机地址
// 0x10: 功能码：写多个寄存器
// 01 05: 写入寄存器起始地址 
// 00 03：写入寄存器长度
// 0x1102，0x0304，0x0566: 写入的数值
// 4a 12: CRC校验值

// 向0x01设备写多个寄存器，寄存器起始地址为0x0105,寄存器长度0x0003,写入内容为0x1102、0x0304、0x0566，校验值为0x4a12
```

```c
// 读多个寄存器
主机发送：01 03 01 05 00 03 14 36  
从机回复：01 03 06 11 22 33 44 55 66 2a 18
```

### Modbus-ASCII数据帧

### Modbus-TCP数据帧


## 两种请求模式

### 单播模式
从机地址必须唯一，地址范围1-247

### 广播模式
主机向所有从机发出请求数据帧，所有从机都会处理，对于广播请求，所有从机无需做出应答

### Modbus地址规则

* 0：广播地址
* 1~247：从机地址
* 248~255：保留
Modbus主机没有地址，只有从机有一个地址




