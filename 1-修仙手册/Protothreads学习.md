### 概念理解

并发：操作系统中，某个时间**段**几个程序在同一个CPU上跑，但在任意一个时间点上只有一个程序在CPU上执行
并行：操作系统有多个CPU，一个CPU处理一个程序，程序之间不相互抢占资源，一个时间点有多个程序在执行

进程：好比程序，是**资源分配的最小单位**
线程：好比程序内的任务和任务之间的关系，线程依赖进程，是**程序执行过程中的最小单元（独立运行和独立调度的基本单位）**

进程线程对比：
* 线程让进程能够实现并发：线程将进程分割成多任务，参与CPU调度
* 线程之间某些资源是独占的
* 进程有自己的资源空间，一个进程可以包含若干线程；
* 线程与CPU资源分配无关，多个线程共享同一进程内的资源
* 线程调度与切换比进程快很多

协程：
又叫微线程，**协程是一种用户态的轻量级线程**
协程有自己的寄存器上下文和栈。协程切换时，将寄存器上下文和栈保存到其他地方，切换回来时，恢复之前保存的上下文和栈。
它相当于一个频繁切换的switch，所有”任务“都在同一个核心上跑，频繁地切换
协程好处：
1. 无须线程上下文切换的开销
2. 无需对资源加锁
3. 方便切换控制流，能简化编程模型
协程缺点：
1. 无法利用CPU多核资源
2. 阻塞时影响整个程序




### Protothreads特性：
1. 纯 C 实现
2. 不用跳转指令
3. 内存占用极小
4. 提供的阻塞不需要堆栈或完整的多线程

五个头文件就是全部
![Pasted image 20230512112615|252](https://raw.githubusercontent.com/24849748/PicBed/main/ob/202306091051651.png)

* `lc.h`：选择`lc-addrlabels.h`或`lc-switch.h`两种实现Protothreads系统
* `lc-addrlables.h`：以字符串方式实现Protothreads系统，占用的ram可能会多些。
* `lc-switch.h`：以标准C的switch结构实现Protothreads系统(默认)
* `pt.h`：在实际应用中一般只包含此文件就行了
* `pt-sem.h`：附加的信号量操作的支持

定义说明：
```c
// 初始化任务变量，只在初始化函数中执行一次就行
PT_INIT(pt);

// 启动任务处理，放在函数开始
PT_BEGIN(pt)

// 结束任务，放在函数最后
PT_END(pt) 

// 等待某个条件成立，否侧就退出任务，下次进入任务从这开始
PT_WAIT_UNTIL(pt, condition) 

// 如果某个条件成立就循环执行，不成立退出任务，下次进入任务从这开始
PT_WAIT_WHILE(pt, condition)

// 新建一个子任务，并等待其执行完成退出
PT_SPAWN(pt, child, thread)

// 重启某个任务执行
PT_RESTART(pt)

// 等待子任务执行完成
PT_WAIT_THREAD(pt, thread)

// 任务后面的部分不执行，直接退出重新执行
PT_EXIT(pt)

// 锁死任务
PT_YIELD(pt)

// 锁死任务并等待条件成立，恢复执行
PT_YIELD_UNTIL(pt, cond)
```

pt中定义了四种线程状态，在任务函数退出到上级函数时返回该状态
* PT_WAITING 等待
* PT_EXITED 退出
* PT_ENDED 结束
* PT_YIELDED 锁死


